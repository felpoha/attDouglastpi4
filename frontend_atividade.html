<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Atividade: Upload Múltiplo</title>
    <style>
      :root {
        --bg: #f0f4f8;
        --card: #ffffff;
        --accent: #6c5ce7;
        --muted: #64748b;
        --success: #16a34a;
        --danger: #ef4444;
        --shadow: 0 8px 30px rgba(14, 22, 39, 0.08);
        font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        background: linear-gradient(180deg, #eef2ff 0%, var(--bg) 60%);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px;
      }
      .wrap {
        width: 100%;
        max-width: 980px;
      }
      header {
        display: flex;
        align-items: center;
        gap: 16px;
        margin-bottom: 18px;
      }
      .logo {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--accent), #a78bfa);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 20px;
        box-shadow: var(--shadow);
      }
      h1 {
        margin: 0;
        font-size: 20px;
      }
      p.lead {
        color: var(--muted);
        margin: 4px 0 0;
      }

      .card {
        background: var(--card);
        border-radius: 14px;
        padding: 28px;
        box-shadow: var(--shadow);
      }

      form.row {
        display: grid;
        grid-template-columns: 1fr 360px;
        gap: 22px;
        align-items: start;
      }

      .left {
        min-height: 160px;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
      }
      .dropzone {
        border: 2px dashed #e6e9ef;
        border-radius: 10px;
        padding: 18px;
        background: linear-gradient(
          180deg,
          rgba(108, 92, 231, 0.04),
          rgba(108, 92, 231, 0.01)
        );
        cursor: pointer;
        transition: all 0.18s ease;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: stretch;
      }
      .dropzone.dragover {
        border-color: var(--accent);
        box-shadow: 0 6px 22px rgba(108, 92, 231, 0.08);
      }
      .dropzone .hint {
        color: var(--muted);
        font-size: 14px;
      }
      .btn {
        display: inline-block;
        padding: 10px 16px;
        border-radius: 8px;
        background: var(--accent);
        color: white;
        border: 0;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 6px 18px rgba(108, 92, 231, 0.12);
      }
      .btn:active {
        transform: translateY(1px);
      }

      .actions {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      .preview-list {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 12px;
      }
      .preview {
        width: 78px;
        height: 78px;
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid #eee;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #fafafa;
        position: relative;
      }
      .preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .preview small {
        position: absolute;
        right: 6px;
        bottom: 6px;
        background: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 10px;
      }
      .preview.invalid {
        border-color: rgba(239, 68, 68, 0.9);
        box-shadow: 0 6px 18px rgba(239, 68, 68, 0.06);
      }
      .preview .bad {
        position: absolute;
        left: 6px;
        top: 6px;
        background: rgba(239, 68, 68, 0.9);
        color: white;
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 10px;
      }

      .right {
        padding: 14px;
        border-radius: 10px;
        background: linear-gradient(180deg, #ffffff, #fbfdff);
        border: 1px solid #f1f5f9;
      }
      .info {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 12px;
      }

      .msg {
        padding: 10px;
        border-radius: 8px;
        font-weight: 600;
        margin-top: 12px;
      }
      .msg.success {
        background: rgba(22, 163, 74, 0.08);
        color: var(--success);
        border: 1px solid rgba(22, 163, 74, 0.12);
      }
      .msg.error {
        background: rgba(239, 68, 68, 0.06);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.12);
      }

      footer {
        margin-top: 14px;
        text-align: right;
        color: var(--muted);
        font-size: 13px;
      }

      @media (max-width: 820px) {
        form.row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <header>
        <div class="logo">UP</div>
        <div>
          <h1>Atividade: Upload Múltiplo</h1>
          <p class="lead">
            Implemente a lógica client-side para enviar múltiplas imagens ao
            servidor em <code>/upload</code>.
          </p>
        </div>
      </header>

      <div class="card">
        <form id="formUpload" class="row">
          <div class="left">
            <label for="arquivoInput">Arquivos para Upload</label>
            <div id="dropzone" class="dropzone" tabindex="0">
              <div
                style="
                  display: flex;
                  justify-content: space-between;
                  align-items: center;
                "
              >
                <strong>Arraste e solte imagens aqui</strong>
                <small style="color: var(--muted)"
                  >PNG ou JPEG — até 10 arquivos</small
                >
              </div>
              <div class="hint">
                ou clique para escolher. Tamanho máximo por arquivo: 5MB.
              </div>
              <input
                id="arquivoInput"
                name="meusArquivos"
                type="file"
                accept="image/png, image/jpeg"
                multiple
                style="display: none"
              />
              <div id="preview" class="preview-list" aria-live="polite"></div>
            </div>

            <div
              style="
                margin-top: 14px;
                display: flex;
                gap: 10px;
                align-items: center;
              "
            >
              <button
                id="btnChoose"
                type="button"
                class="btn"
                style="background: #4b5563"
              >
                Escolher arquivos
              </button>
              <div id="statusInfo" class="info">Nenhum arquivo escolhido</div>
            </div>
          </div>
          <aside class="right">
            <div class="info">
              O backend valida: somente PNG/JPEG, máximo 5MB por arquivo, de 1 a
              10 arquivos.
            </div>

            <div class="actions">
              <button id="btnEnviar" class="btn" type="submit">
                Enviar Arquivos
              </button>
              <button
                id="btnClear"
                class="btn"
                type="button"
                style="background: #ef4444"
              >
                Limpar
              </button>
            </div>

            <div id="mensagem" aria-live="polite"></div>
            <footer>
              Endereço de envio: <code>http://localhost:3000/upload</code>
            </footer>
          </aside>
        </form>
      </div>
    </div>

    <script>
      const arquivoInput = document.getElementById("arquivoInput");
      const dropzone = document.getElementById("dropzone");
      const preview = document.getElementById("preview");
      const statusInfo = document.getElementById("statusInfo");
      const mensagem = document.getElementById("mensagem");
      const btnChoose = document.getElementById("btnChoose");
      const btnClear = document.getElementById("btnClear");
      const form = document.getElementById("formUpload");

      // Abre o seletor de arquivos
      btnChoose.addEventListener("click", () => arquivoInput.click());

      // Limpa seleção
      btnClear.addEventListener("click", () => {
        arquivoInput.value = "";
        preview.innerHTML = "";
        statusInfo.textContent = "Nenhum arquivo escolhido";
        mensagem.innerHTML = "";
      });

      // Drag & drop
      ["dragenter", "dragover"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.add("dragover");
        });
      });
      ["dragleave", "drop"].forEach((evt) => {
        dropzone.addEventListener(evt, (e) => {
          e.preventDefault();
          e.stopPropagation();
          dropzone.classList.remove("dragover");
        });
      });

      dropzone.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        if (dt && dt.files && dt.files.length) {
          arquivoInput.files = dt.files; // set file list
          atualizarPreview();
        }
      });

      // Quando selecionar via diálogo
      arquivoInput.addEventListener("change", atualizarPreview);

      function atualizarPreview() {
        const files = arquivoInput.files;
        preview.innerHTML = "";
        if (!files || files.length === 0) {
          statusInfo.textContent = "Nenhum arquivo escolhido";
          return;
        }
        statusInfo.textContent =
          files.length +
          (files.length === 1
            ? " arquivo selecionado"
            : " arquivos selecionados");

        // regras do backend (espelhadas no cliente para melhor UX)
        const maxFiles = 10;
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ["image/png", "image/jpeg"];
        let anyInvalid = false;

        // Em vez de bloquear, coletemos avisos e exibamos, mas permitimos o envio
        const warnings = [];
        if (files.length > maxFiles) {
          warnings.push(
            `Você selecionou ${files.length} arquivos — o máximo recomendado é ${maxFiles}. O backend pode retornar erro.`
          );
        }

        for (const file of files) {
          const div = document.createElement("div");
          div.className = "preview";
          const small = document.createElement("small");
          small.textContent = prettyBytes(file.size);
          div.appendChild(small);

          // validações por arquivo
          const reasons = [];
          if (!allowedTypes.includes(file.type)) reasons.push("Tipo inválido");
          if (file.size > maxSize) reasons.push("Arquivo maior que 5MB");

          if (reasons.length > 0) {
            anyInvalid = true;
            div.classList.add("invalid");
            const bad = document.createElement("div");
            bad.className = "bad";
            bad.textContent = "Inválido";
            div.appendChild(bad);
            // tooltip / motivo acessível
            div.title = reasons.join(" - ");
          }

          if (file.type.startsWith("image/")) {
            const img = document.createElement("img");
            // preview via FileReader
            const reader = new FileReader();
            reader.onload = (ev) => {
              img.src = ev.target.result;
            };
            reader.readAsDataURL(file);
            div.insertBefore(img, small);
          } else {
            div.textContent = file.name;
          }

          preview.appendChild(div);
        }

        // se houver arquivos inválidos, mostramos aviso resumido
        if (anyInvalid) {
          showMessage(
            "error",
            "Existem arquivos inválidos na seleção. Corrija-os antes de enviar."
          );
        } else {
          // limpa mensagens de erro relacionadas à seleção anterior
          const current = mensagem.querySelector(".msg");
          if (current && current.classList.contains("error"))
            mensagem.innerHTML = "";
        }
        if (warnings.length > 0) {
          showMessage("error", warnings.join(" ; "));
          // prosseguir com o envio para que o backend responda (útil para testar mensagens do Multer)
        }
      }

      function prettyBytes(num) {
        if (num < 1024) return num + " B";
        if (num < 1024 * 1024) return (num / 1024).toFixed(1) + " KB";
        return (num / (1024 * 1024)).toFixed(2) + " MB";
      }

      // Implementação obrigatória: função enviarArquivos
      form.addEventListener("submit", enviarArquivos);

      async function enviarArquivos(event) {
        event.preventDefault();
        mensagem.innerHTML = "";

        const files = arquivoInput.files;

        // Validação cliente: coletar avisos, mas NÃO BLOQUEAR o envio.
        if (!files || files.length === 0) {
          showMessage("error", "Selecione ao menos 1 arquivo para enviar.");
          return;
        }

        const maxFiles = 10;
        const maxSize = 5 * 1024 * 1024; // 5MB
        const allowedTypes = ["image/png", "image/jpeg"];

        const warnings = [];
        if (files.length > maxFiles)
          warnings.push(
            `Você selecionou ${files.length} arquivos — o máximo recomendado é ${maxFiles}.`
          );

        for (const f of files) {
          if (!allowedTypes.includes(f.type))
            warnings.push(`Tipo inválido: ${f.name}`);
          if (f.size > maxSize) warnings.push(`Maior que 5MB: ${f.name}`);
        }

        if (warnings.length > 0) showMessage("error", warnings.join(" ; "));

        // Montar FormData
        const formData = new FormData();

        // Iterar a FileList e anexar cada arquivo com a chave 'meusArquivos'
        for (const file of files) {
          formData.append("meusArquivos", file);
        }

        // Fazer o fetch para o endpoint do backend
        try {
          const response = await fetch("http://localhost:3000/upload", {
            method: "POST",
            body: formData,
            // NÃO definir headers 'Content-Type' ao enviar FormData;
          });

          // Ler resposta como texto primeiro (pode ser JSON ou texto simples)
          const text = await response.text();
          let payload;
          try {
            payload = JSON.parse(text);
          } catch (e) {
            payload = { message: text };
          }

          if (response.ok) {
            const msg = payload.message || "Upload realizado com sucesso.";
            showMessage("success", msg);
            // Opcional: limpar seleção
            // arquivoInput.value = '';
          } else {
            // Mostrar mensagem de erro enviada pelo backend (por exemplo multer)
            const msg =
              payload.message || payload.error || text || "Erro no upload.";
            showMessage("error", `Falha no upload: ${msg}`);
          }
        } catch (err) {
          // Erro de rede ou outro inesperado
          showMessage(
            "error",
            "Não foi possível contatar o servidor. Verifique se o backend está rodando em http://localhost:3000"
          );
          console.error(err);
        }
      }

      function showMessage(type, text) {
        mensagem.innerHTML = "";
        const div = document.createElement("div");
        div.className = "msg " + (type === "success" ? "success" : "error");
        div.textContent = text;
        mensagem.appendChild(div);
      }

      // Inicializa preview vazio
      atualizarPreview();
    </script>
  </body>
</html>
